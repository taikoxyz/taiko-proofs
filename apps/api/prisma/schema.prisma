generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum BatchStatus {
  proposed
  proven
  verified
}

enum ProofSystem {
  TEE
  SP1
  RISC0
}

model Batch {
  batchId                BigInt     @id @map("batch_id")
  proposedAt             DateTime   @map("proposed_at")
  proposedBlock          BigInt     @map("proposed_block")
  proposedTxHash         String?    @map("proposed_tx_hash") @db.VarChar(66)
  proposer               String     @map("proposer") @db.VarChar(42)
  provenAt               DateTime?  @map("proven_at")
  provenBlock            BigInt?    @map("proven_block")
  proofTxHash            String?    @map("proof_tx_hash") @db.VarChar(66)
  verifierAddress        String?    @map("verifier_address") @db.VarChar(42)
  proofSystems           ProofSystem[] @default([]) @map("proof_systems")
  teeVerifiers           String[]   @default([]) @map("tee_verifiers")
  verifiedAt             DateTime?  @map("verified_at")
  verifiedBlock          BigInt?    @map("verified_block")
  verifiedTxHash         String?    @map("verified_tx_hash") @db.VarChar(66)
  status                 BatchStatus @default(proposed) @map("status")
  transitionParentHash   String?    @map("transition_parent_hash") @db.VarChar(66)
  transitionBlockHash    String?    @map("transition_block_hash") @db.VarChar(66)
  transitionStateRoot    String?    @map("transition_state_root") @db.VarChar(66)
  isContested            Boolean    @default(false) @map("is_contested")
  isLegacy               Boolean    @default(false) @map("is_legacy")
  createdAt              DateTime   @default(now()) @map("created_at")
  updatedAt              DateTime   @updatedAt @map("updated_at")

  proofs                 BatchProof[]

  @@index([provenAt])
  @@index([verifiedAt])
  @@index([proposedAt])
  @@index([provenBlock])
  @@index([verifiedBlock])
  @@index([proofSystems], type: Gin)
  @@index([teeVerifiers], type: Gin)
  @@map("batches")
}

model BatchProof {
  id                    String      @id @default(uuid()) @db.Uuid
  batchId               BigInt      @map("batch_id")
  verifierAddress       String      @map("verifier_address") @db.VarChar(42)
  proofSystems          ProofSystem[] @default([]) @map("proof_systems")
  teeVerifiers          String[]    @default([]) @map("tee_verifiers")
  proofTxHash           String      @map("proof_tx_hash") @db.VarChar(66)
  provenAt              DateTime    @map("proven_at")
  provenBlock           BigInt      @map("proven_block")
  transitionParentHash  String      @map("transition_parent_hash") @db.VarChar(66)
  transitionBlockHash   String      @map("transition_block_hash") @db.VarChar(66)
  transitionStateRoot   String      @map("transition_state_root") @db.VarChar(66)
  isVerified            Boolean     @default(false) @map("is_verified")
  createdAt             DateTime    @default(now()) @map("created_at")

  batch                 Batch       @relation(fields: [batchId], references: [batchId])

  @@unique([batchId, proofTxHash])
  @@index([batchId])
  @@index([provenAt])
  @@index([provenBlock])
  @@map("batch_proofs")
}

model DailyStat {
  date                   DateTime   @id @db.Date
  provenTotal            Int        @default(0) @map("proven_total")
  zkProvenTotal          Int        @default(0) @map("zk_proven_total")
  teeTotal               Int        @default(0) @map("tee_total")
  teeSgxGethTotal        Int        @default(0) @map("tee_sgx_geth_total")
  teeSgxRethTotal        Int        @default(0) @map("tee_sgx_reth_total")
  sp1Total               Int        @default(0) @map("sp1_total")
  risc0Total             Int        @default(0) @map("risc0_total")
  provingAvgSeconds      Float?     @map("proving_avg_seconds")
  verificationAvgSeconds Float?     @map("verification_avg_seconds")
  updatedAt              DateTime   @updatedAt @map("updated_at")

  @@map("daily_stats")
}

model IndexingState {
  chainId            Int      @id @map("chain_id")
  lastProcessedBlock BigInt   @map("last_processed_block")
  lockId             String?  @db.Uuid @map("lock_id")
  lockExpiresAt      DateTime? @map("lock_expires_at")
  lastRunStartedAt   DateTime? @map("last_run_started_at")
  lastRunFinishedAt  DateTime? @map("last_run_finished_at")
  lastRunStatus      String?  @map("last_run_status")
  lastRunError       String?  @db.Text @map("last_run_error")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("indexing_state")
}
